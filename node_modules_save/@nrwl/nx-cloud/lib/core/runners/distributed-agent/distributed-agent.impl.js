const a6_0x520d=['existsSync','./node_modules/.cache/nx','Agent\x20','Waiting...','tasks','inherit','number\x20of\x20tasks:\x20','projectName','/tasks-hashes-','parse','floor','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','then','completedTasks','executionId','npx\x20nx\x20run-many\x20--target=','mkdirSync','status','projects','warn','options','throw','../../../utilities/create-unchanged-value-timeout','completedStatusCode','length','error','includes','./distributed-agent.api','maxParallel','value','NX_AGENT_NAME','\x20--projects=','child_process','next','If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.','Error:','NO_FURTHER_TASKS_TO_RUN','CIRCLECI','getRunGroup','criticalErrorMessage','error:\x20','readdirSync','../../../utilities/environment','defineProperty','unlinkSync','execSync','printRunGroupError','Waiter','SIGTERM','getTime','params','Distributed\x20Execution\x20Terminated','.lock','env','status:\x20','../../../utilities/nx-imports','Agent\x20was\x20terminated\x20via\x20SIGINT','reset','toString','message','--configuration=','catch','NO_MESSAGES_TIMEOUT','push','retryDuring','We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','strip-json-comments','Critical\x20Error\x20in\x20Agent:\x20\x22','completed:\x20','Other\x20Nx\x20Cloud\x20Agents\x20Detected','wait','CIRCLE_JOB','done','\x20seconds','readFileSync','cacheDirectory','retryDuring:\x20','completed','Command\x20execution\x20failed\x20(distributed\x20task\x20execution:\x20','completeRunGroupWithError','configuration','Fetching\x20tasks...','VERBOSE_LOGGING',').\x20Tasks\x20hashes\x20haven\x27t\x20been\x20recorded.','../../../utilities/waiter','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','CIRCLE_STAGE','map','note','taskId','DistributedAgentApi','random','assign','createUnchangedValueTimeout','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','No\x20new\x20messages\x20received\x20after\x20','executionId:\x20','exit','SIGINT','target','../../../utilities/metric-logger','/lockfiles'];(function(_0x1ffe17,_0x520d39){const _0x590068=function(_0x5b6f60){while(--_0x5b6f60){_0x1ffe17['push'](_0x1ffe17['shift']());}};_0x590068(++_0x520d39);}(a6_0x520d,0xea));const a6_0x5900=function(_0x1ffe17,_0x520d39){_0x1ffe17=_0x1ffe17-0x0;let _0x590068=a6_0x520d[_0x1ffe17];return _0x590068;};'use strict';var __awaiter=this&&this['__awaiter']||function(_0x16c88b,_0x45a1d3,_0x47cd1e,_0x8fa9e4){function _0x5cf1bc(_0x274dbb){return _0x274dbb instanceof _0x47cd1e?_0x274dbb:new _0x47cd1e(function(_0x54bc1e){_0x54bc1e(_0x274dbb);});}return new(_0x47cd1e||(_0x47cd1e=Promise))(function(_0x7c4d15,_0x278d73){function _0x914c62(_0x1b48d7){try{_0x1ba2d5(_0x8fa9e4[a6_0x5900('0x3')](_0x1b48d7));}catch(_0x4d95fa){_0x278d73(_0x4d95fa);}}function _0x1ce7a4(_0x3aa7e3){try{_0x1ba2d5(_0x8fa9e4[a6_0x5900('0x5d')](_0x3aa7e3));}catch(_0x21be0b){_0x278d73(_0x21be0b);}}function _0x1ba2d5(_0x9e197){_0x9e197[a6_0x5900('0x2a')]?_0x7c4d15(_0x9e197[a6_0x5900('0x65')]):_0x5cf1bc(_0x9e197[a6_0x5900('0x65')])[a6_0x5900('0x54')](_0x914c62,_0x1ce7a4);}_0x1ba2d5((_0x8fa9e4=_0x8fa9e4['apply'](_0x16c88b,_0x45a1d3||[]))[a6_0x5900('0x3')]());});};Object[a6_0x5900('0xd')](exports,'__esModule',{'value':!![]});exports['startAgent']=void 0x0;const child_process_1=require(a6_0x5900('0x2'));const fs_1=require('fs');const stripJsonComments=require(a6_0x5900('0x24'));const create_unchanged_value_timeout_1=require(a6_0x5900('0x5e'));const environment_1=require(a6_0x5900('0xc'));const metric_logger_1=require(a6_0x5900('0x46'));const waiter_1=require(a6_0x5900('0x36'));const print_run_group_error_1=require('../../error/print-run-group-error');const distributed_agent_api_1=require(a6_0x5900('0x63'));const {output,workspaceRoot}=require(a6_0x5900('0x19'));function executeTasks(_0x5cdb9d,_0x5513b1){return __awaiter(this,void 0x0,void 0x0,function*(){let _0x33e5f6=0x0;let _0x28d7a0=null;const _0x132d39=(0x0,create_unchanged_value_timeout_1[a6_0x5900('0x3f')])({'title':a6_0x5900('0x41')+environment_1[a6_0x5900('0x20')]/0x3e8+a6_0x5900('0x2b'),'timeout':environment_1[a6_0x5900('0x20')]});const _0xbcc425=new waiter_1[(a6_0x5900('0x11'))]();let _0x3e0625=[];const _0x3a42a6=new Date();let _0x26aa79=![];while(!![]){if(environment_1[a6_0x5900('0x34')]){output[a6_0x5900('0x3a')]({'title':a6_0x5900('0x33')});}_0x28d7a0=yield _0x5513b1['tasks'](_0x28d7a0?_0x28d7a0['executionId']:null,_0x33e5f6,_0x3e0625);if(environment_1[a6_0x5900('0x34')]){output[a6_0x5900('0x3a')]({'title':'API\x20Response','bodyLines':[a6_0x5900('0x26')+_0x28d7a0[a6_0x5900('0x2f')],a6_0x5900('0x18')+_0x28d7a0[a6_0x5900('0x59')],a6_0x5900('0x2e')+_0x28d7a0['retryDuring'],a6_0x5900('0x42')+_0x28d7a0[a6_0x5900('0x56')],a6_0x5900('0x4e')+_0x28d7a0[a6_0x5900('0x4c')]['length'],a6_0x5900('0xa')+_0x28d7a0['criticalErrorMessage'],'maxParallel:\x20'+_0x28d7a0[a6_0x5900('0x64')]]});}if(_0x28d7a0[a6_0x5900('0x9')]){output[a6_0x5900('0x61')]({'title':a6_0x5900('0x15'),'bodyLines':[a6_0x5900('0x5'),_0x28d7a0[a6_0x5900('0x9')]]});process[a6_0x5900('0x43')](0x0);}if((_0x28d7a0===null||_0x28d7a0===void 0x0?void 0x0:_0x28d7a0[a6_0x5900('0x22')])&&(_0x28d7a0===null||_0x28d7a0===void 0x0?void 0x0:_0x28d7a0[a6_0x5900('0x22')])!==0x0&&!_0x26aa79&&new Date()[a6_0x5900('0x13')]()-_0x3a42a6['getTime']()>_0x28d7a0[a6_0x5900('0x22')]){yield _0xbcc425[a6_0x5900('0x28')]();continue;}if((_0x28d7a0===null||_0x28d7a0===void 0x0?void 0x0:_0x28d7a0[a6_0x5900('0x59')])!==undefined){if(_0x28d7a0[a6_0x5900('0x59')]==='RUN_GROUP_COMPLETED'||_0x28d7a0['status']===a6_0x5900('0x6')){return;}}else if(_0x28d7a0[a6_0x5900('0x2f')]){return;}_0x132d39(_0x28d7a0[a6_0x5900('0x4c')][a6_0x5900('0x39')](_0x58300b=>_0x58300b[a6_0x5900('0x3b')])['join'](''));if(!_0x28d7a0[a6_0x5900('0x56')]){if(environment_1['VERBOSE_LOGGING']){output[a6_0x5900('0x3a')]({'title':a6_0x5900('0x4b')});}yield _0xbcc425[a6_0x5900('0x28')]();_0x33e5f6=0x0;_0x3e0625=[];continue;}_0xbcc425[a6_0x5900('0x1b')]();_0x26aa79=!![];const _0x378598=invokeTasksUsingRunMany(_0x5cdb9d,_0x28d7a0[a6_0x5900('0x56')],_0x28d7a0[a6_0x5900('0x4c')],_0x28d7a0[a6_0x5900('0x64')]);_0x33e5f6=_0x378598[a6_0x5900('0x5f')];_0x3e0625=_0x378598[a6_0x5900('0x55')];}});}function readCompletedTasks(_0x5ba7e6,_0x15caa0){const _0x3998db=a6_0x5900('0x30')+_0x15caa0+a6_0x5900('0x35');let _0x52611c;try{const _0xeaaa9b=_0x5ba7e6[a6_0x5900('0x2d')]||a6_0x5900('0x49');const _0x14f1aa=_0xeaaa9b+a6_0x5900('0x50')+_0x15caa0;_0x52611c=JSON['parse']((0x0,fs_1[a6_0x5900('0x2c')])(_0x14f1aa)[a6_0x5900('0x1c')]());(0x0,fs_1[a6_0x5900('0xe')])(_0x14f1aa);}catch(_0x553774){throw new Error(_0x3998db);}if(_0x52611c['length']==0x0){throw new Error(_0x3998db);}return _0x52611c;}function invokeTasksUsingRunMany(_0x3e7f17,_0x40b275,_0x545a7f,_0x1115c1){let _0x1cdc65=0x0;const _0x58534d=[];for(const _0x199f7a of groupByTarget(_0x545a7f)){const _0x44d33f=_0x199f7a[a6_0x5900('0x32')]?a6_0x5900('0x1e')+_0x199f7a['configuration']:'';const _0x1914bd=_0x1115c1>0x1?'\x20--parallel\x20--max-parallel='+_0x1115c1:'';const _0x31727a=a6_0x5900('0x57')+_0x199f7a[a6_0x5900('0x45')]+'\x20'+_0x44d33f+a6_0x5900('0x1')+_0x199f7a[a6_0x5900('0x5a')]['join'](',')+'\x20'+_0x199f7a['params']+_0x1914bd;if(environment_1[a6_0x5900('0x34')]){output[a6_0x5900('0x3a')]({'title':'Executing:\x20\x27'+_0x31727a+'\x27'});}try{(0x0,child_process_1[a6_0x5900('0xf')])(_0x31727a,{'stdio':[a6_0x5900('0x4d'),a6_0x5900('0x4d'),a6_0x5900('0x4d')],'env':Object[a6_0x5900('0x3e')](Object['assign']({},process[a6_0x5900('0x17')]),{'NX_CACHE_FAILURES':'true','NX_CLOUD_DISTRIBUTED_EXECUTION_ID':_0x40b275})});_0x58534d[a6_0x5900('0x21')](...readCompletedTasks(_0x3e7f17,_0x40b275));}catch(_0x4d763b){if(_0x4d763b[a6_0x5900('0x59')]===environment_1['DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE']){throw _0x4d763b;}else{_0x1cdc65=0x1;_0x58534d[a6_0x5900('0x21')](...readCompletedTasks(_0x3e7f17,_0x40b275));}}}return{'completedStatusCode':_0x1cdc65,'completedTasks':_0x58534d};}function groupByTarget(_0x29237f){const _0x450ddc=[];_0x29237f['forEach'](_0x3ed4a8=>{const _0x3ff0d7=_0x450ddc['find'](_0x1a860c=>_0x1a860c[a6_0x5900('0x45')]===_0x3ed4a8[a6_0x5900('0x45')]&&_0x1a860c[a6_0x5900('0x32')]===_0x3ed4a8[a6_0x5900('0x32')]);if(_0x3ff0d7){_0x3ff0d7['projects'][a6_0x5900('0x21')](_0x3ed4a8[a6_0x5900('0x4f')]);}else{_0x450ddc['push']({'target':_0x3ed4a8['target'],'projects':[_0x3ed4a8['projectName']],'params':_0x3ed4a8[a6_0x5900('0x14')],'configuration':_0x3ed4a8[a6_0x5900('0x32')]});}});return _0x450ddc;}function getAgentName(){if(process[a6_0x5900('0x17')][a6_0x5900('0x0')]!==undefined){return process[a6_0x5900('0x17')][a6_0x5900('0x0')];}else if(process[a6_0x5900('0x17')][a6_0x5900('0x7')]!==undefined&&process[a6_0x5900('0x17')][a6_0x5900('0x38')]){return process[a6_0x5900('0x17')][a6_0x5900('0x38')];}else if(process['env'][a6_0x5900('0x7')]!==undefined&&process[a6_0x5900('0x17')]['CIRCLE_JOB']){return process['env'][a6_0x5900('0x29')];}else{return a6_0x5900('0x4a')+Math[a6_0x5900('0x52')](Math[a6_0x5900('0x3d')]()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x479ba3,_0x5dcdc1,_0x39f079){const _0x3409a0=_0x5dcdc1[a6_0x5900('0x2d')]||a6_0x5900('0x49');const _0x1d752c=_0x3409a0+a6_0x5900('0x47');const _0x264437=_0x1d752c+'/'+_0x39f079+a6_0x5900('0x16');if(!(0x0,fs_1['existsSync'])(_0x1d752c)){(0x0,fs_1[a6_0x5900('0x58')])(_0x1d752c,{'recursive':!![]});}const _0x1a4a00=(0x0,fs_1[a6_0x5900('0xb')])(_0x1d752c);if(_0x1a4a00[a6_0x5900('0x60')]){if(_0x1a4a00[a6_0x5900('0x62')](_0x39f079+a6_0x5900('0x16'))){output['error']({'title':'Duplicate\x20Agent\x20ID\x20Detected','bodyLines':[a6_0x5900('0x53'),'','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.']});process['exit'](0x1);}output[a6_0x5900('0x5b')]({'title':a6_0x5900('0x27'),'bodyLines':[a6_0x5900('0x23'),'',a6_0x5900('0x40'),a6_0x5900('0x4')]});}(0x0,fs_1['writeFileSync'])(_0x264437,'');process['on'](a6_0x5900('0x43'),_0x2d3b06=>{cleanupAgentLockfile(_0x264437,_0x2d3b06);});process['on'](a6_0x5900('0x12'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x479ba3[a6_0x5900('0x31')]('Agent\x20was\x20terminated\x20via\x20SIGTERM');cleanupAgentLockfile(_0x264437,0x1);}));process['on'](a6_0x5900('0x44'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x479ba3[a6_0x5900('0x31')](a6_0x5900('0x1a'));cleanupAgentLockfile(_0x264437,0x1);}));}function cleanupAgentLockfile(_0x33fdf9,_0x2f0b02){if((0x0,fs_1[a6_0x5900('0x48')])(_0x33fdf9)){(0x0,fs_1['unlinkSync'])(_0x33fdf9);process['exit'](_0x2f0b02);}}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x185c58=(0x0,environment_1[a6_0x5900('0x8')])();if(!_0x185c58){(0x0,print_run_group_error_1[a6_0x5900('0x10')])();return process[a6_0x5900('0x43')](0x1);}output['note']({'title':a6_0x5900('0x37')});const _0x45065e=JSON[a6_0x5900('0x51')](stripJsonComments((0x0,fs_1[a6_0x5900('0x2c')])(workspaceRoot+'/nx.json')[a6_0x5900('0x1c')]()))['tasksRunnerOptions']['default'][a6_0x5900('0x5c')];const _0x352dc5=getAgentName();const _0x27930d=new distributed_agent_api_1[(a6_0x5900('0x3c'))](_0x45065e,_0x185c58,_0x352dc5);createAgentLockfileAndSetUpListeners(_0x27930d,_0x45065e,_0x352dc5);return executeTasks(_0x45065e,_0x27930d)[a6_0x5900('0x54')](_0x44d2bb=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1['submitRunMetrics'])(_0x45065e);return _0x44d2bb;}))[a6_0x5900('0x1f')](_0x340a3f=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x27930d[a6_0x5900('0x31')](a6_0x5900('0x25')+_0x340a3f[a6_0x5900('0x1d')]+'\x22');throw _0x340a3f;}));});}exports['startAgent']=startAgent;